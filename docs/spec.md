# å›è»¢å¯¿å¸ã‚ªãƒ¼ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  ä»•æ§˜æ›¸

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 ç›®çš„

- å®¢ãŒã‚¿ãƒƒãƒãƒ‘ãƒãƒ«ã‹ã‚‰å¯¿å¸ã‚’æ³¨æ–‡ã§ãã‚‹
- æ³¨æ–‡ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¨æˆ¿ã«å±Šã
- å¨æˆ¿ã‚¹ã‚¿ãƒƒãƒ•ãŒèª¿ç†é–‹å§‹ãƒ»é…è†³å®Œäº†ã‚’æ“ä½œã§ãã‚‹
- å®¢ã®ç”»é¢ã§æ³¨æ–‡çŠ¶æ³ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã•ã‚Œã‚‹
- **ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•** ã§æ³¨æ–‡ â†’ èª¿ç† â†’ é…è†³ã®æµã‚Œã‚’å®Ÿç¾

### 1.2 ä½¿ç”¨æŠ€è¡“

| ã‚«ãƒ†ã‚´ãƒª | æŠ€è¡“ |
|---------|------|
| ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  | Deno |
| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ | Hono (TypeScript) |
| DB ã‚¢ã‚¯ã‚»ã‚¹ | Kysely + PostgreSQL |
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ / ã‚¹ã‚­ãƒ¼ãƒå®šç¾© | Zod (@hono/zod-openapi) |
| API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | OpenAPIï¼ˆ@hono/zod-openapiï¼‰ |
| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚¹ | NATS |
| ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° | SSE (Server-Sent Events) |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | React (Vite) |
| ãƒ¢ãƒãƒ¬ãƒç®¡ç† | Deno workspaces |
| é–‹ç™ºç’°å¢ƒç®¡ç† | mise |
| ã‚¤ãƒ³ãƒ•ãƒ© | Docker Compose |

### 1.3 ãƒ¢ãƒãƒ¬ãƒæ§‹æˆ

```
hono-advent-calendar-2025/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/           # Hono API ã‚µãƒ¼ãƒ
â”‚   â”‚   â””â”€â”€ deno.json
â”‚   â”œâ”€â”€ poller/        # Poller (NATS publisher)
â”‚   â”‚   â””â”€â”€ deno.json
â”‚   â”œâ”€â”€ sse-server/    # Hono SSE ã‚µãƒ¼ãƒ
â”‚   â”‚   â””â”€â”€ deno.json
â”‚   â””â”€â”€ web/           # å¨æˆ¿ç”»é¢ + å®¢ã®ç”»é¢ (React + Vite)
â”‚       â””â”€â”€ deno.json
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ spec.md
â”œâ”€â”€ deno.json          # ãƒ«ãƒ¼ãƒˆè¨­å®š (workspaces)
â”œâ”€â”€ docker-compose.yml # PostgreSQL, NATS
â””â”€â”€ mise.toml          # mise è¨­å®š
```

**è¨­è¨ˆæ–¹é‡:** 
- å„ã‚¢ãƒ—ãƒªã¯ç‹¬ç«‹ã€‚å…±æœ‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ä½œã‚‰ãšã€å¿…è¦ãªå‹ã¯å„ã‚¢ãƒ—ãƒªã§å®šç¾©ã™ã‚‹ã€‚
- ã‚¤ãƒ™ãƒ³ãƒˆå‹ï¼ˆ5è¡Œç¨‹åº¦ï¼‰ã¯ api, poller, sse-server ã§é‡è¤‡ã—ã¦å®šç¾©ã€‚ã‚µãƒ³ãƒ—ãƒ«ã®è¦æ¨¡ã§ã¯è¨±å®¹ç¯„å›²ã€‚
- å¤§è¦æ¨¡ã‚·ã‚¹ãƒ†ãƒ ã§ã¯å…±æœ‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚„ã‚¹ã‚­ãƒ¼ãƒãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’æ¤œè¨ã€‚

---

## 2. ç”¨èª

| ç”¨èª | èª¬æ˜ |
|------|------|
| **æ³¨æ–‡ï¼ˆOrderï¼‰** | å®¢ãŒæ³¨æ–‡ã—ãŸå¯¿å¸ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã€å•†å“åã€æ•°é‡ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æŒã¤ |
| **å¨æˆ¿ç”»é¢** | å¨æˆ¿ã‚¹ã‚¿ãƒƒãƒ•ãŒæ–°è¦æ³¨æ–‡ã‚’ç¢ºèªã—ã€èª¿ç†é–‹å§‹ãƒ»é…è†³å®Œäº†ã‚’æ“ä½œã™ã‚‹ç”»é¢ |
| **å®¢ã®ç”»é¢** | å®¢ãŒæ³¨æ–‡ã‚’è¡Œã„ã€æ³¨æ–‡çŠ¶æ³ã‚’ç¢ºèªã™ã‚‹ç”»é¢ |
| **Poller** | `event_outbox` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æœªé€ä¿¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã—ã€NATS ã¸ publish ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ |
| **SSE ã‚µãƒ¼ãƒ** | NATS ã‚’ subscribe ã—ã€å—ã‘å–ã£ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’ SSE ã§ãƒ–ãƒ©ã‚¦ã‚¶ã¸é€ä¿¡ã™ã‚‹ Hono ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |

---

## 3. ä¸»ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

### 3.1 ãƒ‡ãƒ¢ã‚·ãƒŠãƒªã‚ª

**ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¿ãƒ–ã‚’2ã¤é–‹ã„ã¦ãƒ‡ãƒ¢:**

```
ã‚¿ãƒ–1: http://localhost:5173/customer?table=5  (å®¢ã®ç”»é¢)
ã‚¿ãƒ–2: http://localhost:5173/kitchen           (å¨æˆ¿ã®ç”»é¢)
```

1. ã‚¿ãƒ–1ï¼ˆå®¢ï¼‰ã§ã€Œã¾ãã‚ Ã—2ã€ã‚’æ³¨æ–‡
2. ã‚¿ãƒ–2ï¼ˆå¨æˆ¿ï¼‰ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ³¨æ–‡ãŒè¡¨ç¤ºã•ã‚Œã‚‹
3. å¨æˆ¿ãŒã€Œèª¿ç†é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ã‚¿ãƒ–1ï¼ˆå®¢ï¼‰ã§ã€Œèª¿ç†ä¸­...ã€ã«æ›´æ–°ã•ã‚Œã‚‹
5. å¨æˆ¿ãŒã€Œé…è†³å®Œäº†ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
6. ã‚¿ãƒ–1ï¼ˆå®¢ï¼‰ã§ã€ŒãŠå±Šã‘å®Œäº†ï¼ã€ã«æ›´æ–°ã•ã‚Œã‚‹

### 3.2 å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ³¨æ–‡ã®æµã‚Œ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. å®¢ãŒæ³¨æ–‡                                                                â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  2. API: orders ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¿å…¥ (status = ordered)                           â”‚
â”‚     â”‚    event_outbox ã« order.created ã‚’è¨˜éŒ²                               â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  3. Poller: event_outbox â†’ NATS ã« publish                                  â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  4. SSE ã‚µãƒ¼ãƒ: NATS â†’ SSE ã§å¨æˆ¿ç”»é¢ã« push                                â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  5. å¨æˆ¿ç”»é¢: æ–°è¦æ³¨æ–‡ãŒè¡¨ç¤ºã•ã‚Œã‚‹                                           â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  6. å¨æˆ¿ã‚¹ã‚¿ãƒƒãƒ•ãŒã€Œèª¿ç†é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯                                      â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  7. API: orders ã‚’æ›´æ–° (status = cooking)                                   â”‚
â”‚     â”‚    event_outbox ã« order.cookingStarted ã‚’è¨˜éŒ²                        â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  8. Poller â†’ NATS â†’ SSE â†’ å®¢ã®ç”»é¢: ã€Œèª¿ç†ä¸­...ã€ã«æ›´æ–°                     â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  9. å¨æˆ¿ã‚¹ã‚¿ãƒƒãƒ•ãŒã€Œé…è†³å®Œäº†ã€ã‚’ã‚¯ãƒªãƒƒã‚¯                                      â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  10. API: orders ã‚’æ›´æ–° (status = delivered)                                â”‚
â”‚      â”‚   event_outbox ã« order.delivered ã‚’è¨˜éŒ²                             â”‚
â”‚      â”‚                                                                      â”‚
â”‚      â–¼                                                                      â”‚
â”‚  11. Poller â†’ NATS â†’ SSE â†’ å®¢ã®ç”»é¢: ã€ŒãŠå±Šã‘å®Œäº†ï¼ã€ã«æ›´æ–°                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 4.1 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Web ã‚¢ãƒ—ãƒª (React)                              â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚     å®¢ã®ç”»é¢         â”‚              â”‚    å¨æˆ¿ã®ç”»é¢        â”‚             â”‚
â”‚   â”‚  /customer?table=5  â”‚              â”‚    /kitchen         â”‚             â”‚
â”‚   â”‚                     â”‚              â”‚                     â”‚             â”‚
â”‚   â”‚  â€¢ æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ       â”‚              â”‚  â€¢ æ–°è¦æ³¨æ–‡ä¸€è¦§      â”‚             â”‚
â”‚   â”‚  â€¢ æ³¨æ–‡çŠ¶æ³è¡¨ç¤º      â”‚              â”‚  â€¢ èª¿ç†ä¸­ä¸€è¦§        â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚              â”‚ POST /api/orders                   â”‚ GET, PUT               â”‚
â”‚              â”‚ SSE /events                        â”‚ SSE /events            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                    â”‚
               â–¼                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Hono API ã‚µãƒ¼ãƒ (:3000)                  â”‚
â”‚                                                              â”‚
â”‚  â€¢ POST /api/orders           æ³¨æ–‡ä½œæˆ                        â”‚
â”‚  â€¢ GET  /api/orders           æ³¨æ–‡ä¸€è¦§å–å¾—                    â”‚
â”‚  â€¢ PUT  /api/orders/:id/start èª¿ç†é–‹å§‹                        â”‚
â”‚  â€¢ PUT  /api/orders/:id/deliver é…è†³å®Œäº†                      â”‚
â”‚  â€¢ GET  /api/doc              OpenAPI ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   PostgreSQL    â”‚
                    â”‚                 â”‚
                    â”‚  â€¢ orders       â”‚
                    â”‚  â€¢ event_outbox â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Poller       â”‚â”€â”€â”€â–¶â”‚      NATS       â”‚â—€â”€â”€â”€â”‚   SSE ã‚µãƒ¼ãƒ (:3001) â”‚
â”‚                  â”‚    â”‚  order.events   â”‚    â”‚                      â”‚
â”‚ event_outbox     â”‚    â”‚                 â”‚    â”‚  GET /events         â”‚
â”‚ â†’ NATS publish   â”‚    â”‚                 â”‚    â”‚  NATS â†’ SSE push     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å½¹å‰²

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | å½¹å‰² |
|---------------|------|
| **Hono API ã‚µãƒ¼ãƒ** | REST API æä¾›ã€æ³¨æ–‡ã®ä½œæˆãƒ»æ›´æ–°ã€ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ² |
| **Poller** | `event_outbox` ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã€NATS ã¸ã‚¤ãƒ™ãƒ³ãƒˆã‚’ publish |
| **NATS ã‚µãƒ¼ãƒ** | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚¹ã€‚ãƒˆãƒ”ãƒƒã‚¯: `order.events` |
| **Hono SSE ã‚µãƒ¼ãƒ** | `/events` SSE ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€‚NATS subscribe â†’ SSE push |
| **å®¢ã®ç”»é¢** | æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã€æ³¨æ–‡çŠ¶æ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º |
| **å¨æˆ¿ã®ç”»é¢** | æ–°è¦æ³¨æ–‡ä¸€è¦§ã€èª¿ç†é–‹å§‹ãƒ»é…è†³å®Œäº†ã®æ“ä½œ |

---

## 5. ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ä»•æ§˜ï¼ˆPostgreSQLï¼‰

### 5.1 è¨­è¨ˆæ–¹é‡

- **DB ã¯ snake_case**: PostgreSQL ã®æ¨™æº–ã«å¾“ã†
- **TypeScript ã¯ camelCase**: Kysely ã® `CamelCasePlugin` ã§è‡ªå‹•å¤‰æ›
- **ã‚·ãƒ³ãƒ—ãƒ«**: æ³¨æ–‡ã¯1ãƒ¬ã‚³ãƒ¼ãƒ‰1å•†å“ï¼ˆOrderItem ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä½œã‚‰ãªã„ï¼‰

### 5.2 `orders` ãƒ†ãƒ¼ãƒ–ãƒ«

| ã‚«ãƒ©ãƒ å | å‹ | èª¬æ˜ |
|---------|-----|------|
| id | UUID | æ³¨æ–‡ IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| table_number | INTEGER | ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå· |
| item_name | TEXT | å•†å“åï¼ˆä¾‹: ã¾ãã‚ï¼‰ |
| quantity | INTEGER | æ•°é‡ |
| status | TEXT | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (`ordered` / `cooking` / `delivered`) |
| created_at | TIMESTAMPTZ | æ³¨æ–‡æ—¥æ™‚ |
| updated_at | TIMESTAMPTZ | æ›´æ–°æ—¥æ™‚ |

```sql
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    table_number INTEGER NOT NULL,
    item_name TEXT NOT NULL,
    quantity INTEGER NOT NULL DEFAULT 1,
    status TEXT NOT NULL DEFAULT 'ordered',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_table_number ON orders(table_number);
CREATE INDEX idx_orders_created_at ON orders(created_at DESC);
```

### 5.3 `event_outbox` ãƒ†ãƒ¼ãƒ–ãƒ«

| ã‚«ãƒ©ãƒ å | å‹ | èª¬æ˜ |
|---------|-----|------|
| id | BIGSERIAL | ã‚¤ãƒ™ãƒ³ãƒˆ IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| type | TEXT | ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥ |
| aggregate_id | UUID | é›†ç´„ IDï¼ˆæ³¨æ–‡ IDï¼‰ |
| payload | JSONB | ã‚¤ãƒ™ãƒ³ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ |
| processed | BOOLEAN | é€ä¿¡æ¸ˆã¿ãƒ•ãƒ©ã‚° |
| created_at | TIMESTAMPTZ | ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ—¥æ™‚ |

```sql
CREATE TABLE event_outbox (
    id BIGSERIAL PRIMARY KEY,
    type TEXT NOT NULL,
    aggregate_id UUID NOT NULL,
    payload JSONB NOT NULL,
    processed BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_event_outbox_unprocessed ON event_outbox(id)
    WHERE processed = FALSE;
```

### 5.4 Kysely å‹å®šç¾©

**db/types.ts**

```typescript
import type { Generated } from "kysely";

// orders ãƒ†ãƒ¼ãƒ–ãƒ«
export interface OrderTable {
  id: Generated<string>;
  tableNumber: number;
  itemName: string;
  quantity: number;
  status: string;
  createdAt: Generated<Date>;
  updatedAt: Generated<Date>;
}

// event_outbox ãƒ†ãƒ¼ãƒ–ãƒ«
export interface EventOutboxTable {
  id: Generated<number>;
  type: string;
  aggregateId: string;
  payload: unknown;
  processed: boolean;
  createdAt: Generated<Date>;
}

// Database å‹
export interface Database {
  orders: OrderTable;
  eventOutbox: EventOutboxTable;  // DB: event_outbox
}
```

---

## 6. ã‚¤ãƒ™ãƒ³ãƒˆãƒ¢ãƒ‡ãƒ«ä»•æ§˜

### 6.1 ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥

| ã‚¤ãƒ™ãƒ³ãƒˆ | èª¬æ˜ | ãƒˆãƒªã‚¬ãƒ¼ |
|---------|------|---------|
| `order.created` | æ³¨æ–‡ãŒä½œæˆã•ã‚ŒãŸ | å®¢ãŒæ³¨æ–‡ |
| `order.cookingStarted` | èª¿ç†ãŒé–‹å§‹ã•ã‚ŒãŸ | å¨æˆ¿ãŒã€Œèª¿ç†é–‹å§‹ã€ |
| `order.delivered` | é…è†³ãŒå®Œäº†ã—ãŸ | å¨æˆ¿ãŒã€Œé…è†³å®Œäº†ã€ |

### 6.2 ã‚¤ãƒ™ãƒ³ãƒˆ payload

**ã‚·ãƒ³ãƒ—ãƒ«ã« ID ã¨ type ã ã‘ã€‚** è©³ç´°ã¯ API ã§å–å¾—ã€‚

```json
{
  "type": "order.created",
  "orderId": "550e8400-e29b-41d4-a716-446655440000",
  "tableNumber": 5
}
```

```json
{
  "type": "order.cookingStarted",
  "orderId": "550e8400-e29b-41d4-a716-446655440000",
  "tableNumber": 5
}
```

```json
{
  "type": "order.delivered",
  "orderId": "550e8400-e29b-41d4-a716-446655440000",
  "tableNumber": 5
}
```

**tableNumber ã‚’å«ã‚ã‚‹ç†ç”±:** å®¢ã®ç”»é¢ã§è‡ªåˆ†ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡ã ã‘ãƒ•ã‚£ãƒ«ã‚¿ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

### 6.3 ã‚¤ãƒ™ãƒ³ãƒˆã®æµã‚Œ

```
å®¢ãŒæ³¨æ–‡
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API ã‚µãƒ¼ãƒï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ï¼‰      â”‚
â”‚                                     â”‚
â”‚  1. orders ã« INSERT (ordered)      â”‚
â”‚  2. event_outbox ã«è¨˜éŒ²             â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼ éåŒæœŸ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Poller                              â”‚
â”‚                                     â”‚
â”‚  3. event_outbox ã‹ã‚‰å–å¾—           â”‚
â”‚  4. NATS ã« publish                 â”‚
â”‚  5. processed = true                â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SSE ã‚µãƒ¼ãƒ                          â”‚
â”‚                                     â”‚
â”‚  6. NATS subscribe                  â”‚
â”‚  7. SSE ã§ push                     â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¨æˆ¿ã®ç”»é¢                          â”‚
â”‚                                     â”‚
â”‚  8. æ–°è¦æ³¨æ–‡ãŒè¡¨ç¤ºã•ã‚Œã‚‹             â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. API ä»•æ§˜

### 7.1 å…±é€š

- ãƒ™ãƒ¼ã‚¹ URL: `/api`
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼: JSON
- CORS: æœ‰åŠ¹ï¼ˆ`http://localhost:5173` ã‚’è¨±å¯ï¼‰

### 7.2 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

#### POST /api/orders

æ³¨æ–‡ä½œæˆï¼ˆå®¢ãŒæ³¨æ–‡ï¼‰

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£:**
```json
{
  "tableNumber": 5,
  "itemName": "ã¾ãã‚",
  "quantity": 2
}
```

**å‡¦ç†:**
1. `orders` ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¿å…¥ï¼ˆstatus = orderedï¼‰
2. `event_outbox` ã« `order.created` ã‚’è¨˜éŒ²

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "tableNumber": 5,
  "itemName": "ã¾ãã‚",
  "quantity": 2,
  "status": "ordered",
  "createdAt": "2025-11-29T12:34:56Z",
  "updatedAt": "2025-11-29T12:34:56Z"
}
```

#### GET /api/orders

æ³¨æ–‡ä¸€è¦§å–å¾—ï¼ˆå¨æˆ¿ç”¨ï¼‰

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**
| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | å¿…é ˆ | èª¬æ˜ |
|-----------|-----|------|------|
| status | string | No | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒ•ã‚£ãƒ«ã‚¿ |
| tableNumber | number | No | ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã§ãƒ•ã‚£ãƒ«ã‚¿ |

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```json
{
  "orders": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "tableNumber": 5,
      "itemName": "ã¾ãã‚",
      "quantity": 2,
      "status": "ordered",
      "createdAt": "2025-11-29T12:34:56Z",
      "updatedAt": "2025-11-29T12:34:56Z"
    }
  ]
}
```

#### PUT /api/orders/:id/start

èª¿ç†é–‹å§‹ï¼ˆå¨æˆ¿ãŒæ“ä½œï¼‰

**å‡¦ç†:**
1. `orders` ã‚’æ›´æ–°ï¼ˆstatus = cookingï¼‰
2. `event_outbox` ã« `order.cookingStarted` ã‚’è¨˜éŒ²

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```json
{
  "ok": true
}
```

#### PUT /api/orders/:id/deliver

é…è†³å®Œäº†ï¼ˆå¨æˆ¿ãŒæ“ä½œï¼‰

**å‡¦ç†:**
1. `orders` ã‚’æ›´æ–°ï¼ˆstatus = deliveredï¼‰
2. `event_outbox` ã« `order.delivered` ã‚’è¨˜éŒ²

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```json
{
  "ok": true
}
```

#### GET /api/doc

OpenAPI ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆSwagger UIï¼‰è¡¨ç¤º

---

## 8. apps/api ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹æˆ

```
apps/api/
â”œâ”€â”€ deno.json
â”œâ”€â”€ main.ts                       # Hono ã‚¢ãƒ—ãƒªèµ·å‹•
â”œâ”€â”€ migrate.ts                    # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
â”œâ”€â”€ seed.ts                       # ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿
â”‚
â”œâ”€â”€ handlers/                     # HTTP ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆè–„ã„ï¼‰
â”‚   â”œâ”€â”€ createOrder.ts            # POST /api/orders
â”‚   â”œâ”€â”€ getOrders.ts              # GET /api/orders
â”‚   â”œâ”€â”€ startCooking.ts           # PUT /api/orders/:id/start
â”‚   â””â”€â”€ deliverOrder.ts           # PUT /api/orders/:id/deliver
â”‚
â”œâ”€â”€ order/                        # æ³¨æ–‡ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆCommandï¼‰
â”‚   â”œâ”€â”€ createOrder.ts            # ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹: æ³¨æ–‡ä½œæˆ
â”‚   â”œâ”€â”€ startCooking.ts           # ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹: èª¿ç†é–‹å§‹
â”‚   â”œâ”€â”€ deliverOrder.ts           # ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹: é…è†³å®Œäº†
â”‚   â””â”€â”€ schema.ts                 # Zod ã‚¹ã‚­ãƒ¼ãƒ
â”‚
â”œâ”€â”€ dao/                          # Queryï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
â”‚   â””â”€â”€ orderDao.ts               # æ³¨æ–‡ä¸€è¦§å–å¾—
â”‚
â””â”€â”€ db/
    â”œâ”€â”€ client.ts                 # Kysely ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    â”œâ”€â”€ types.ts                  # DB å‹å®šç¾©
    â””â”€â”€ migrations/
        â”œâ”€â”€ 0001_create_orders.ts
        â””â”€â”€ 0002_create_event_outbox.ts
```

### è²¬å‹™

| å±¤ | è²¬å‹™ |
|---|------|
| **handlers/** | HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç† |
| **order/** | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆCommandï¼‰ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç† |
| **dao/** | èª­ã¿å–ã‚Šå°‚ç”¨ã‚¯ã‚¨ãƒª |
| **db/** | DB æ¥ç¶šã€å‹å®šç¾©ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |

---

## 9. apps/poller ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹æˆ

```
apps/poller/
â”œâ”€â”€ deno.json
â”œâ”€â”€ main.ts                       # ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
â”œâ”€â”€ events.ts                     # ã‚¤ãƒ™ãƒ³ãƒˆå‹ï¼ˆapi ã¨åŒã˜å®šç¾©ï¼‰
â””â”€â”€ db/
    â”œâ”€â”€ client.ts                 # Kysely ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    â””â”€â”€ types.ts                  # event_outbox ã®å‹
```

### 9.1 å½¹å‰²

1. `event_outbox` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ `processed = false` ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
2. NATS ã®ãƒˆãƒ”ãƒƒã‚¯ï¼ˆ`order.events`ï¼‰ã« publish
3. publish æˆåŠŸå¾Œã€è©²å½“ã‚¤ãƒ™ãƒ³ãƒˆã® `processed` ã‚’ `true` ã«æ›´æ–°

### 9.2 ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”

- ã‚µãƒ³ãƒ—ãƒ«: 1ç§’ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§é‡è¦–ï¼‰

---

## 10. apps/sse-server ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹æˆ

```
apps/sse-server/
â”œâ”€â”€ deno.json
â”œâ”€â”€ main.ts                       # SSE ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ + NATS subscribe
â””â”€â”€ events.ts                     # ã‚¤ãƒ™ãƒ³ãƒˆå‹ï¼ˆapi ã¨åŒã˜å®šç¾©ï¼‰
```

### 10.1 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### GET /events

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**
| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | å¿…é ˆ | èª¬æ˜ |
|-----------|-----|------|------|
| tableNumber | number | No | æŒ‡å®šã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿å—ã‘å–ã‚‹ |

**æŒ¯ã‚‹èˆã„:**
1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæ¥ç¶šã—ãŸã‚‰ NATS ã® `order.events` ã‚’ subscribe
2. tableNumber ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ã€ãã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
3. å—ä¿¡ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’ SSE ã¨ã—ã¦é€ä¿¡
4. 30ç§’é–“éš”ã§ keep-alive ã‚’é€ä¿¡

### 10.2 SSE ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼

```
: keepalive

data: {"type":"order.created","orderId":"...","tableNumber":5}

data: {"type":"order.cookingStarted","orderId":"...","tableNumber":5}
```

---

## 11. apps/web ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹æˆ

```
apps/web/
â”œâ”€â”€ deno.json
â”œâ”€â”€ index.html
â”œâ”€â”€ vite.config.ts
â””â”€â”€ src/
    â”œâ”€â”€ main.tsx                  # ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
    â”œâ”€â”€ App.tsx                   # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    â”œâ”€â”€ api/
    â”‚   â””â”€â”€ client.ts             # API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    â”œâ”€â”€ hooks/
    â”‚   â””â”€â”€ useOrderEvents.ts     # SSE ãƒ•ãƒƒã‚¯
    â””â”€â”€ pages/
        â”œâ”€â”€ CustomerPage.tsx      # å®¢ã®ç”»é¢
        â””â”€â”€ KitchenPage.tsx       # å¨æˆ¿ã®ç”»é¢
```

### 11.1 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- React + TypeScript
- Vite
- TanStack Query
- Tailwind CSS

### 11.2 ç”»é¢æ§‹æˆ

#### å®¢ã®ç”»é¢ (`/customer?table=5`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ£ ãƒ†ãƒ¼ãƒ–ãƒ« 5                                    [ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ : â—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  ã”æ³¨æ–‡                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å•†å“: [ã¾ãã‚        â–¼]  æ•°é‡: [2]  [æ³¨æ–‡ã™ã‚‹]              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  ã”æ³¨æ–‡çŠ¶æ³                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ã¾ãã‚ Ã—2      ğŸ”¥ èª¿ç†ä¸­...                                 â”‚   â”‚
â”‚  â”‚ ã‚µãƒ¼ãƒ¢ãƒ³ Ã—1    âœ… ãŠå±Šã‘å®Œäº†ï¼                              â”‚   â”‚
â”‚  â”‚ ãˆã³ Ã—3        ğŸ“ æ³¨æ–‡å—ä»˜                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å¨æˆ¿ã®ç”»é¢ (`/kitchen`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ£ å¨æˆ¿                                          [ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ : â—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  ğŸ“¥ æ–°è¦æ³¨æ–‡                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ãƒ†ãƒ¼ãƒ–ãƒ«5  ã¾ãã‚ Ã—2     12:34   [èª¿ç†é–‹å§‹]                  â”‚   â”‚
â”‚  â”‚ ãƒ†ãƒ¼ãƒ–ãƒ«3  ã‚µãƒ¼ãƒ¢ãƒ³ Ã—1   12:35   [èª¿ç†é–‹å§‹]                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”¥ èª¿ç†ä¸­                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ãƒ†ãƒ¼ãƒ–ãƒ«2  ãˆã³ Ã—3       12:30   [é…è†³å®Œäº†]                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.3 SSE ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‡¦ç†

```typescript
// hooks/useOrderEvents.ts
export function useOrderEvents(tableNumber?: number) {
  const queryClient = useQueryClient();

  useEffect(() => {
    const url = tableNumber 
      ? `http://localhost:3001/events?tableNumber=${tableNumber}`
      : 'http://localhost:3001/events';
    
    const source = new EventSource(url);
    
    source.onmessage = (e) => {
      const event = JSON.parse(e.data);
      
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ– â†’ è‡ªå‹•ã§å†å–å¾—
      queryClient.invalidateQueries({ queryKey: ['orders'] });
    };
    
    return () => source.close();
  }, [queryClient, tableNumber]);
}
```

---

## 12. Docker Compose æ§‹æˆ

### 12.1 ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§

| ã‚µãƒ¼ãƒ“ã‚¹ | ãƒãƒ¼ãƒˆ | èª¬æ˜ |
|---------|--------|------|
| postgres | 5432 | PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ |
| nats | 4222 | NATS ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚¹ |

**ã‚¢ãƒ—ãƒªï¼ˆapi, sse-server, poller, webï¼‰ã¯ Deno ã§ç›´æ¥èµ·å‹•ã€‚**

### 12.2 docker-compose.yml

```yaml
services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: sushi
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  nats:
    image: nats:2-alpine
    ports:
      - "4222:4222"

volumes:
  postgres_data:
```

---

## 13. é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 13.1 mise è¨­å®š

```toml
# mise.toml
[tools]
deno = "2"
```

### 13.2 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

```bash
# mise ã§ Deno ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
mise install

# ä¾å­˜é–¢ä¿‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
deno install

# ã‚¤ãƒ³ãƒ•ãƒ©ã®èµ·å‹•ï¼ˆPostgreSQL, NATSï¼‰
docker compose up -d

# DB ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
deno task -r api migrate

# é–‹ç™ºã‚µãƒ¼ãƒã®èµ·å‹•ï¼ˆå…¨ã‚¢ãƒ—ãƒªï¼‰
deno task dev
```

### 13.3 èµ·å‹•å¾Œã®ãƒãƒ¼ãƒˆ

| ã‚µãƒ¼ãƒ“ã‚¹ | ãƒãƒ¼ãƒˆ | èµ·å‹•æ–¹æ³• |
|---------|--------|---------|
| PostgreSQL | 5432 | Docker |
| NATS | 4222 | Docker |
| API ã‚µãƒ¼ãƒ | 3000 | Deno |
| SSE ã‚µãƒ¼ãƒ | 3001 | Deno |
| Web (Vite) | 5173 | Deno |

### 13.4 ãƒ«ãƒ¼ãƒˆ deno.json

```json
{
  "workspace": [
    "./apps/api",
    "./apps/poller",
    "./apps/sse-server",
    "./apps/web"
  ],
  "tasks": {
    "dev": "deno task --parallel dev:api dev:sse dev:poller dev:web",
    "dev:api": "deno task -r api dev",
    "dev:sse": "deno task -r sse-server dev",
    "dev:poller": "deno task -r poller dev",
    "dev:web": "deno task -r web dev"
  }
}
```

---

## 14. ä»Šå¾Œã®æ‹¡å¼µæ¡ˆ

1. **ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒã‚¹ã‚¿**: å•†å“ä¸€è¦§ã‚’ DB ã§ç®¡ç†
2. **ä¼šè¨ˆæ©Ÿèƒ½**: ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã®åˆè¨ˆé‡‘é¡ã€ç²¾ç®—å‡¦ç†
3. **èª¿ç†å„ªå…ˆåº¦**: æ³¨æ–‡é † or å•†å“ç¨®é¡ã§å„ªå…ˆåº¦ã‚’è¨­å®š
4. **è¤‡æ•°å¨æˆ¿å¯¾å¿œ**: å¯¿å¸æ‹…å½“ã€æšã’ç‰©æ‹…å½“ãªã©ã«åˆ†ã‘ã‚‹
5. **ãƒ¬ãƒ¼ãƒ³é…è†³**: ç›´æ¥é…è†³ vs ãƒ¬ãƒ¼ãƒ³é…è†³ã®é¸æŠ

